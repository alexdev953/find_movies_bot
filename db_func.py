import sqlite3


class DbFunc:

    def __init__(self):
        self.conn = None
        self.cur = self.db_connect()

    def db_connect(self):
        self.conn = sqlite3.connect('bot.db')
        cur = self.conn.cursor()
        return cur

    def check_user(self, message):
        user_cred = message.from_user
        # logger.debug(f'Check USER {user_id}, {first_name}, {user_name}')
        self.cur.execute(f"select userid from users where userid = {user_cred.id}")
        info = self.cur.fetchall()
        if not info:
            self.cur.execute(f"insert into users (userid, username, firstname, lastname) values "
                             f"('{user_cred.id}', '{user_cred.username}', '{user_cred.first_name}', '{user_cred.last_name}')")
            self.conn.commit()
            self.conn.close()
        else:
            self.cur.execute(f"update users set last_uses = datetime('now', 'localtime') where userid = {user_cred.id};")
            self.conn.commit()
            self.conn.close()

    def insert_movies(self, data):
        # data = [{'id_film': '27583', 'name': 'Земля кочевников', 'url': '/films/dramy/27583-zemlya-kochevnikov.html', 'poster': 'http://baskino.me/uploads/images/2021/255/oidm193.jpg'}, {'id_film': '27568', 'name': 'Поколение Вояджер', 'url': '/films/priklyuchencheskie/27568-pokolenie-voyadzher.html', 'poster': 'http://baskino.me/uploads/images/2021/653/debl86.jpg'}, {'id_film': '27558', 'name': 'Митчеллы против машин / На связи', 'url': '/films/multfilmy/27558-mitchelly-protiv-mashin-na-svyazi.html', 'poster': 'http://baskino.me/uploads/images/2021/249/tars317.jpg'}, {'id_film': '27462', 'name': 'Мортал Комбат', 'url': '/films/boevie-iskustva/27462-mortal-kombat.html', 'poster': 'http://baskino.me/uploads/images/2021/341/dzvo310.jpg'}, {'id_film': '27451', 'name': 'Дальний космос', 'url': '/films/dramy/27451-dalniy-kosmos.html', 'poster': 'http://baskino.me/uploads/images/2021/486/xapn224.jpg'}, {'id_film': '27414', 'name': 'Игры шпионов', 'url': '/films/trillery/27414-igry-shpionov.html', 'poster': 'http://baskino.me/uploads/images/2021/891/enms731.jpg'}, {'id_film': '27372', 'name': 'Никто', 'url': '/films/boeviki/27372-nikto.html', 'poster': 'http://baskino.me/uploads/images/2021/829/bhjw345.jpg'}, {'id_film': '27371', 'name': 'Афера по-голливудски', 'url': '/films/komedii/27371-afera-po-gollivudski.html', 'poster': 'http://baskino.me/uploads/images/2021/322/hcnu244.jpg'}, {'id_film': '27346', 'name': 'Заступник', 'url': '/films/boeviki/27346-zastupnik.html', 'poster': 'http://baskino.me/uploads/images/2021/995/ccdm253.jpg'}, {'id_film': '27265', 'name': 'Сила Грома', 'url': '/films/boeviki/27265-sila-groma.html', 'poster': 'http://baskino.me/uploads/images/2021/768/gmdm579.jpg'}, {'id_film': '27199', 'name': 'Поступь хаоса', 'url': '/films/priklyuchencheskie/27199-postup-haosa.html', 'poster': 'http://baskino.me/uploads/images/2021/479/snvk109.jpg'}, {'id_film': '27148', 'name': 'Годзилла против Конга', 'url': '/films/boeviki/27148-godzilla-protiv-konga.html', 'poster': 'http://baskino.me/uploads/images/2021/363/dnwp685.jpg'}, {'id_film': '27098', 'name': 'Отец', 'url': '/films/dramy/27098-otec.html', 'poster': 'http://baskino.me/uploads/images/2021/219/qxbn63.jpg'}, {'id_film': '26970', 'name': 'Лига справедливости Зака Снайдера', 'url': '/films/boeviki/26970-liga-spravedlivosti-zaka-snaydera.html', 'poster': 'http://baskino.me/uploads/images/2021/206/gtwf899.jpg'}, {'id_film': '26914', 'name': 'День «да»', 'url': '/films/komedii/26914-den-da.html', 'poster': 'http://baskino.me/uploads/images/2021/008/cnne204.jpg'}, {'id_film': '26897', 'name': 'По наклонной', 'url': '/films/dramy/26897-po-naklonnoy.html', 'poster': 'http://baskino.me/uploads/images/2021/322/vdzd389.jpg'}, {'id_film': '26804', 'name': 'Райя и последний дракон', 'url': '/films/multfilmy/26804-rayya-i-posledniy-drakon.html', 'poster': 'http://baskino.me/uploads/images/2021/847/bray131.jpg'}, {'id_film': '26793', 'name': 'Поездка в Америку 2', 'url': '/films/komedii/26793-poezdka-v-ameriku-2.html', 'poster': 'http://baskino.me/uploads/images/2021/705/jcjd714.jpg'}, {'id_film': '26783', 'name': 'Мавританец', 'url': '/films/dramy/26783-mavritanec.html', 'poster': 'http://baskino.me/uploads/images/2021/852/disw453.jpg'}, {'id_film': '26709', 'name': 'Том и Джерри', 'url': '/films/komedii/26709-tom-i-dzherri.html', 'poster': 'http://baskino.me/uploads/images/2021/253/yain386.jpg'}, {'id_film': '26609', 'name': 'Охотник на монстров', 'url': '/films/boeviki/26609-ohotnik-na-monstrov.html', 'poster': 'http://baskino.me/uploads/images/2021/756/dmnk33.jpg'}, {'id_film': '26603', 'name': 'Дать дуба в округе Юба', 'url': '/films/dramy/26603-dat-duba-v-okruge-yuba.html', 'poster': 'http://baskino.me/uploads/images/2021/424/jhlh941.jpg'}, {'id_film': '26432', 'name': 'Афера Оливера Твиста', 'url': '/films/boeviki/26432-afera-olivera-tvista.html', 'poster': 'http://baskino.me/uploads/images/2021/791/agtb303.jpg'}, {'id_film': '26406', 'name': 'Палмер', 'url': '/films/dramy/26406-palmer.html', 'poster': 'http://baskino.me/uploads/images/2021/365/oxre224.jpg'}, {'id_film': '26389', 'name': 'Дьявол в деталях', 'url': '/films/detektivy/26389-dyavol-v-detalyah.html', 'poster': 'http://baskino.me/uploads/images/2021/068/vebw38.jpg'}, {'id_film': '26387', 'name': 'Охана: В поисках сокровища', 'url': '/films/boeviki/26387-ohana-v-poiskah-sokrovischa.html', 'poster': 'http://baskino.me/uploads/images/2021/197/ieas733.jpg'}, {'id_film': '26242', 'name': 'Смертельная зона', 'url': '/films/boeviki/26242-smertelnaya-zona.html', 'poster': 'http://baskino.me/uploads/images/2021/294/ebrr991.jpg'}, {'id_film': '26090', 'name': 'Повелитель драконов', 'url': '/films/multfilmy/26090-povelitel-drakonov.html', 'poster': 'http://baskino.me/uploads/images/2021/104/zehu889.jpg'}, {'id_film': '26064', 'name': 'Душа', 'url': '/films/melodramy/26064-dusha.html', 'poster': 'http://baskino.me/uploads/images/2020/739/frgy597.jpg'}, {'id_film': '26041', 'name': 'Чудо-женщина: 1984', 'url': '/films/boeviki/26041-chudo-zhenschina-1984.html', 'poster': 'http://baskino.me/uploads/images/2020/198/jfjn657.jpg'}, {'id_film': '26024', 'name': 'Полночное небо', 'url': '/films/dramy/26024-polnochnoe-nebo.html', 'poster': 'http://baskino.me/uploads/images/2020/573/dzuv568.jpg'}, {'id_film': '25965', 'name': 'Семейка Крудс: Новоселье', 'url': '/films/multfilmy/25965-semeyka-kruds-novosele.html', 'poster': 'http://baskino.me/uploads/images/2020/708/atqs174.jpg'}, {'id_film': '25944', 'name': 'Дублерша', 'url': '/films/komedii/25944-dublersha.html', 'poster': 'http://baskino.me/uploads/images/2020/277/uupp341.jpg'}, {'id_film': '25935', 'name': 'Не все дома', 'url': '/films/komedii/25935-ne-vse-doma.html', 'poster': 'http://baskino.me/uploads/images/2020/331/zlbg201.jpg'}, {'id_film': '25874', 'name': 'Фея-крестная / Крестная мать', 'url': '/films/komedii/25874-feya-krestnaya.html', 'poster': 'http://baskino.me/uploads/images/2020/760/irvo536.jpg'}, {'id_film': '25865', 'name': 'Честный вор', 'url': '/films/boeviki/25865-chestnyy-vor.html', 'poster': 'http://baskino.me/uploads/images/2020/917/wexs952.jpg'}, {'id_film': '25852', 'name': 'Дичь', 'url': '/films/komedii/25852-dich.html', 'poster': 'http://baskino.me/uploads/images/2020/492/yyvc859.jpg'}, {'id_film': '25841', 'name': 'Манк', 'url': '/films/biograficheskie/25841-mank.html', 'poster': 'http://baskino.me/uploads/images/2020/122/bgxn692.jpg'}, {'id_film': '25807', 'name': 'Довод', 'url': '/films/boeviki/25807-dovod.html', 'poster': 'http://baskino.me/uploads/images/2020/218/coos635.jpg'}, {'id_film': '25779', 'name': 'Рождественские хроники 2', 'url': '/films/komedii/25779-rozhdestvenskie-hroniki-2.html', 'poster': 'http://baskino.me/uploads/images/2020/536/awsy592.jpg'}, {'id_film': '25749', 'name': 'Взаперти', 'url': '/films/detektivy/25749-vzaperti.html', 'poster': 'http://baskino.me/uploads/images/2020/705/gwgw489.jpg'}, {'id_film': '25732', 'name': 'Авангард: Арктические волки', 'url': '/films/boevie-iskustva/25732-avangard-arkticheskie-volki.html', 'poster': 'http://baskino.me/uploads/images/2020/091/zwod273.jpg'}, {'id_film': '25718', 'name': 'Гнездо', 'url': '/films/dramy/25718-gnezdo.html', 'poster': 'http://baskino.me/uploads/images/2020/918/mzwj35.jpg'}, {'id_film': '25689', 'name': 'Гренландия', 'url': '/films/boeviki/25689-grenlandiya.html', 'poster': 'http://baskino.me/uploads/images/2020/805/lipw56.jpg'}, {'id_film': '25638', 'name': 'Семейка Бигфутов', 'url': '/films/multfilmy/25638-semeyka-bigfutov.html', 'poster': 'http://baskino.me/uploads/images/2020/488/ecfx404.jpg'}, {'id_film': '19742', 'name': 'Новые мутанты', 'url': '/films/boeviki/19742-novye-mutanty.html', 'poster': 'http://baskino.me/uploads/images/2019/785/vbox426.jpg'}, {'id_film': '25621', 'name': 'Губка Боб в бегах', 'url': '/films/multfilmy/25621-gubka-bob-v-begah.html', 'poster': 'http://baskino.me/uploads/images/2020/301/ypvo768.jpg'}, {'id_film': '25552', 'name': 'Шесть минут до полуночи', 'url': '/films/dramy/25552-shest-minut-do-polunochi.html', 'poster': 'http://baskino.me/uploads/images/2020/799/vqao531.jpg'}, {'id_film': '25535', 'name': 'Последняя капля', 'url': '/films/dramy/25535-poslednyaya-kaplya.html', 'poster': 'http://baskino.me/uploads/images/2020/447/gsue854.jpg'}, {'id_film': '25531', 'name': 'Путешествие на Луну', 'url': '/films/multfilmy/25531-puteshestvie-na-lunu.html', 'poster': 'http://baskino.me/uploads/images/2020/235/zjwx865.jpg'}]
        for val in data:
            films_id = val['id_film']
            name = val['name']
            url = val['url']
            poster_url = val['poster']
            self.cur.execute(f"insert into films (films_id, name, url, poster_url) values ({films_id}, '{name}', '{url}', '{poster_url}')")
            self.conn.commit()
        self.conn.close()

    def search_film_id(self, id_film):
        self.cur.execute(f'select url from films where films_id = {id_film}')
        info = self.cur.fetchone()
        if info:
            print(info[0])
            self.conn.close()
            return info[0]
        else:
            raise Exception('Nothing found')
